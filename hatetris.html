<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
		<title>HATETRIS Evolver</title>
		<link rel="stylesheet" type="text/css" href="reset.css" />
		<link rel="stylesheet" type="text/css" href="style.css" />
    <!-- Grapher is the graphing library -->
    <script language="javascript" src="grapher.js"></script>
    <!-- Original Hatetris code - modified slightly for speed -->
    <script language="javascript" src="hatetris.js"></script>
		<script type="text/javascript"><!--
      function spaceEvery4(inputString){
        var output = '';
        for(var i=0;i<inputString.length;i++){
          if (i>0 && i%4 ==0)
            output += ' ';
          output+=inputString.charAt(i);
        }
        return output;
      }
      
      function randomGame(){
        var returnString = '';
        var hexChart = new Array();
        for(var i=0;i<10;i++){
          hexChart[i] = i;
        }
//        hexChart[10] = 'A';
        hexChart[10] = 'B';
        hexChart[11] = 'C';
        hexChart[12] = 'D';
        hexChart[13] = 'E';
        hexChart[14] = 'F';
        //adding a plus 45 because 45 is the minimum number of plays
        //necessary to die
        numberChars = Math.floor(Math.random()*1000)+45;

        for(var i=0;i<numberChars;i++){
          //Make extra A's
          var a = Math.floor(Math.random()*100);
         
          if (a <= parseInt(document.getElementById('aPercent').value)){
            returnString+='A';
          }
          else{
            returnString += hexChart[Math.floor(Math.random()*15)];
          }
        }
        return returnString;
      }

      function playOne(game){
        startReplay(game);
        //TODO if startReplay returns a positive number, that's the number of moves after we die, if 0 then perfect length, if -1 then too short?
        //TODO shouldn't we use livewell.score instead of fetching the innerHTML?
        return document.getElementById('score').innerHTML
      }

      function workloop(population,popSize){
        generationLimit =parseInt(document.getElementById('genSize').value);
        //Add initial Series for Graph
        Grapher.addSeries("avgFit");
        Grapher.addSeries("avgGenomeLength");
        Grapher.addSeries("maxFitness");
        var avgFit;
        var lengthSort = false;
        function work(j){
          avgFit = 0;
          totLen =0;
          for(var i=0;i<popSize;i++){
            population[i].fitness = parseInt(playOne(population[i].genome));
            //Tweek the fitness by -0.5 if the length is less than 45, the minimum number of moves to die
            //we only need to tweek by 0.5 since length must be > 45 in order to have any points
            //TODO should there be more done with this? For example, pad anyone less than 45 with a random string?
            if(population[i].genome.length < 45)
              population[i].fitness -= 0.5;
            avgFit+=population[i].fitness;
            totLen+= population[i].genome.length;
          }
          //TODO parameterize this?
          //gives us 200 generations of trying to prune random crap out before we move on to letting it grow
          //also checking that we have any kind of fitness may or may not be important
          if(j%1000 && population[0].fitness > 0)
            lengthSort = true;
          if(j%1200)
            lengthSort = false
          if(lengthSort)
            population.sort(sortByFitnessAndGenome);
          else
            population.sort(sortByFitness);
          //TODO for when fitness is 0, add a fitness value for length of genome? under the argument that a long genome is more likely to fill everyting in?
          var table = document.getElementById('fitHistory');
          var row = document.createElement('tr');
          var td1 = document.createElement('td');
          td1.appendChild(document.createTextNode(j));
          var td2 = document.createElement('td');
          td2.appendChild(document.createTextNode(population[0].fitness));
          var td3 = document.createElement('td');
          td3.appendChild(document.createTextNode(avgFit/popSize));
          var td4 = document.createElement('td');
          td4.appendChild(document.createTextNode(totLen/popSize));
          var td5 = document.createElement('td');
          td5.appendChild(document.createTextNode(spaceEvery4(population[0].genome)));
          row.appendChild(td1);
          row.appendChild(td2);
          row.appendChild(td3);
          row.appendChild(td4);
          row.appendChild(td5);
          table.appendChild(row);
          
          //Graphing
          //alert(avgFit/popSize);
//          if(avgFit==0) avgFit+= 0.01;
          Grapher.addDataPoint(avgFit/popSize,'c','avgFit');
          Grapher.addDataPoint(totLen/popSize,'c','avgGenomeLength');
          Grapher.addDataPoint(population[0].fitness,'c','maxFitness');
          if(j!=0){
            Grapher.draw('c');
          }
          

          //fitness evaluated, rearrange individuals
          //copy over the best by simply adding the offset in the next loop
          
          //cross over all individuals, crossing 1 with 2, 3 with 4, etc.
          //off set is 4
          toSave = Math.floor(((document.getElementById('save').value)/100)*popSize);
          for(var k=0;k<16;k+=2){
            genome1 = population[k].genome;
            genome2 = population[k+1].genome;
            splitPoint1 = Math.floor(Math.random()*genome1.length);
            splitPoint2 = Math.floor(Math.random()*genome2.length);
            rGenome1 = "";
            rGenome2 = "";
            for(var i =0;i<splitPoint1;i++){
              rGenome1+=genome1.charAt(i);
            }
            for(var i=splitPoint2;i<genome2.length;i++){
              rGenome1+=genome2.charAt(i);
            }
            for(var i =0;i<splitPoint2;i++){
              rGenome2+=genome2.charAt(i);
            }
            for(var i=splitPoint1;i<genome1.length;i++){
              rGenome2+=genome1.charAt(i);
            }
            population[k+toSave].genome = rGenome1;
            population[k+toSave+1].genome = rGenome2;
          }
          //randomly cut out chunks of genome
          //TODO is this actually better? Just reconsider this area...
          for(var k=4;k<popSize;k++){
            //TODO make this a parameter
            g = population[k].genome
            point = Math.floor(Math.random()*g.length);
            //cut out up to half of genome
            len = Math.floor((Math.random()*g.length)/2);
            population[k].genome='';
            for(var l=0;l<point;l++){
              population[k].genome+=g.charAt(l);
            }
            for(var l=point+len;l<g.length;l++){
              population[k].genome+=g.charAt(l);
            }
          }
          //random Mutation
          var l=0;
          for(var k=17;k<popSize;k++){
            population[k] = Array();
            population[k].fitness = 0;
            
            //This is for mutating the bottom ones to totally random
            //population[k].genome = randomGame();

            //This is for mutating from the top
            g = population[l].genome;
            population[k].genome='';
            point = Math.floor(Math.random()*g.length);//should we set bounds here?
            for(var m=0;m<point;m++){
              population[k].genome+=population[l].genome.charAt(m);
            }
            population[k].genome += randomGame();
            
          }
          //pad anyone less than 45 with a bunch of random crap
          for(var k=0;k<popSize;k++){
            if(population[k].genome.length < 45){
              population[k].genome += randomGame();
            }
          }
          j++;
          //window.scrollBy(0,500);//This is an arbritrary amount
          if(j<generationLimit) window.setTimeout(function(){ work(j); }, 300);
        }
        work(0);
      }
      //This is really fitness related, but this way, when fitness is equal and greater than 1, it'll prefer the shorter solution
      //TODO this might make things worse, since games might not finish - might want to &&a.genome.length > 500 or something
      function sortByFitnessAndGenome(a,b){
        if(a.fitness > b.fitness)
          return -1;
        else if (a.fitness < b.fitness)
          return 1;
        else if(a.fitness == b.fitness && a.fitness>0 && a.genome.length>60 && b.genome.length>60){
          if(a.genome.length < b.genome.length)
            return -1;
          else if (a.genome.length > b.genome.length)
            return 1;
        }
        return 0;
//        return ((a.fitness > b.fitness) ? -1 : (a.fitness < b.fitness) ? 1:0);
      }
      function sortByFitness(a,b){
        return ((a.fitness > b.fitness) ? -1 : (a.fitness < b.fitness) ? 1:0);
      }
      function evolve(){
        //clear the existing canvas
        Grapher.clear('c');
        //clear out the existing text in our table
        document.getElementById('fitHistory').innerHTML = "";
        var population = Array();
        function critter(fitness,genome){
          this.fitness = fitness;
          this.genome = genome.split(' ').join("");;
        }

        var popSize = 24;
        for(var i=0;i<popSize;i++){
          population[population.length++] = new critter(0,randomGame());
        }
        //cheat, and seed awesome plays
        if(document.options.one.checked){
          population[population.length++] = new critter(0,'AAAB 00AA AAAA AB0A AAAA AAAA AAAE AAAA AD6A AAAA AAC0 0AAA AAAA C02A AAAA AAB2 28AA AAAC 2AAA AAAA E2AA AAAB 6AAA A8AA 97A5 6AAA AAAA AAEA AAAE AABA AABA ABAA');
          popSize++;
        }
        if(document.options.two.checked){
          population[population.length++] = new critter(0,'56AA AAAA AA9A AAAA AAAA 8AAA AAAA AA00 AAAA AAAA ACAA AA8A AAB2 AAAA AAA5 6AAA AAAA 9AAA AAAA AEAA AAAA 9F5A AAAA ABD6 AAAA AAD5 6AAA AAAB 00AA AAAA AEAA AAAA FD6A AAAA BD56 AAAA AF5A AAAA FEAA');
          popSize++;
        }
        if(document.options.three.checked){
          population[population.length++] = new critter(0,'032A AAAA AAAA 8C00 AAAA AA8C AAAA AAAA AB00 AAAA AB22 AAAA AABA AAAA AAA8 0002 EAAA A8C0 AAAA B0AA AAAA B000 16AA AAA7 2AAA AAAA EAAA AAA7 6AAA AAAA AD6A AAAA AAD5 556A AAAA AA95 56AA AAAA AA6A AAAA AA55 6AAA AAAA 8AAA AAA9 4AAA AAAA 9556 AAAA AAA0 2AAA AAAA AA8A A6AA AAAA A556 AAAA AA00 02AA AAA0 00AA AAA2 AAAA 2AAA 82A6 AAAA A2AA 62AA A56A AAA2 D6AA AA95 76AA AA80 0AAA AAA8 02AA A802 AAA8 00AA ACAA AAEA AAD6 AAAA B556 AAAA 556A AAA6 AAAB D555 6AAA 8AAA A02A AAD5 AAAB 6AAB 555A AB56 AAE2 AA00 F7AA AC2A A83A A7AA B5AA C000 AAA5 A82A B000 A8');
          popSize++;
        }
        if(document.options.four.checked){
          population[population.length++] = new critter(0,'56AA AAAA AA9A AAAA AAAA 8AAA AAAA AA00 AAAA AAAA ACAA AA8A AAB2 AAAA AAA5 6AAA AAAA 9AAA AAAA AEAA AAAA 9F5A AAAA ABD6 AAAA AAD5 6AAA AAAB 00AA AAAA AEAA AAAA FD6A AAAA BD56 AAAA AF5A AAAA FEAA AAB5 5AAA ABC2 AAAA 9BF0 0AAA AAA6 BBF0 0AAA AAAB AC02 AAAA AAEA AAAB 6AAA AB55 AAAA B56A AAAB 5AAA AA80 AAAA AA82 AAAA AB2A AAAC 02AA AAAB F6AA AAFE AAA5 6AAA AF56 AAAD 56AA BF55 AABC 2AAA 6FC0 2AAA A6BB F00A AAAA EB00 AAAA AE5A AAEA AADA AAA0 2AAA A82A AAAC AAAC 02AA AAD5 5AAA B5C0 AAB5 6AA9 AAAF 6ABD 56AB F00A AA6B BF00 AAAB A5AA B00A AAB2 AA5A A96A B55A A80A AA80 2AAA C2AA B0AA C02A AC02 A9C2 A9E9 76A6 AAEA');
          popSize++;
        }
        workloop(population,popSize);
      }
/*
TODO: figure out use of external JS files, so that we can pull some of this crap out of here.
TODO: make display of genome optional
TODO: right idea with length, I think, but we want to see if they're dead yet. If you're not dead, you should be longer. Maybe this will help prevent stagnation?
TODO: fitness might be most improved by providing a decimal increase for a situation where we have:
|xxxxxxxx  |        |xxx  xxxx|  The important thing is that 2 slot opening, when almost any piece can provide a point.          
|xxxxxxxx  |    or  |xxx  xxxx|
------------        ----------|
To counter previous point, isn't that what most people have been doing? Valid strategy, but limiting.
TODO: Can we limit stagnation by promoting diversity? Provide two highs for fitness in the same population? Sort for both and then cross both from list a to list b and from a to a and b to b? 
*/
		// --></script>

	</head>
	<body style="margin: 10px;" onload="createPlayingField();">
		<div style="display:none;">
			<table>
				<tbody id="welltbody">
				</tbody>
			</table>
		</div>
		<div style="margin: 10px">
      <h3 style="font-size:175%;">Hatetris Solver</h3>
      <p style="margin-left:0">Be warned that this takes a long time to run. Expect 10k generations to take 8 hours or so on Chrome, Windows, with a 2GHz processor.</p>
			<p style="margin-left:0;"><a href="http://qntm.org/hatetris">Inspired by HATETRIS by Sam Hughes</a></p>
      <form name="options">
        <table>
        <tr><td><fieldset>
          <legend>Global Options</legend>
            <label><span>Number of Generations:</span>
              <input type="text" name="genSize" id="genSize" value="20">
            </label><br><br>
            <label><span>Percent to Save?</span>
              <input type="text" name="save" id="save" value="20">
            </label><br>
            <label><span>% of a randomly genome that is 'A' (drop, drop)</span>
              <input type="text" name="aPercent" id="aPercent" value="20">
            </label><br>
          </fieldset></td>
        <td><fieldset>
          <legend>Initial Population</legend>
            <p>Check the ones you'd like to include in the inital population. Including higher point runs seems to prevent much evolution.</p>
            <label><span>1 Point</span>
              <input type="checkbox" name="one" id="one">
            </label><br>
            <label><span>Alternate 1 Point</span>
              <input type="checkbox" name="two" id="two">
            </label><br>
            <label><span>11 Points</span>
              <input type="checkbox" name="three" id="three">
            </label><br>
            <label><span>17 Points</span>
              <input type="checkbox" name="four" id="four">
            </label><br>
        </fieldset></td></tr>
       </table>
       </form>
<!--			<p><button type="button" onclick="startGame(0);">start new game</button></p>
			<p><button type="button" onclick="startReplay();">show a replay</button></p>-->
      <p><button type="button" onClick="evolve();">Evolve</button></p>
      <canvas id="c" width="900" height="300"></canvas>
			<p><span id="score"></span></p>
			<!--<p><span id="replayOut"></span></p>-->
      <table>
        <tr><th>Generation</th><th>Max Fit</th><th>Avg Fit</th><th>Average Genome Length</th><th>Genome</th></tr>
        <tbody id="fitHistory">
        </tbody>
      </table>
		</div>
	</body>
</html> 
